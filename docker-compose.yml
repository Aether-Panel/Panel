version: '3.8'

services:
  skypanel:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - version=dev-docker
        - sha=local-build
    container_name: skypanel
    restart: unless-stopped
    
    # Puertos
    ports:
      - "8080:8080"   # Panel web
      - "5657:5657"   # SFTP
      - "8081:8081"   # Gatus (monitoring)
    
    # Volúmenes persistentes
    volumes:
      - skypanel-config:/etc/SkyPanel
      - skypanel-data:/var/lib/SkyPanel
      - skypanel-logs:/var/log/SkyPanel
      # Socket de Docker para gestionar contenedores (opcional)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
    # Variables de entorno
    environment:
      - GIN_MODE=release
      - PUFFER_PLATFORM=docker
      - PUFFER_DOCKER_ROOT=
      - PUFFER_DOCKER_DISALLOWHOST=true
      # Configuración del panel
      - PUFFER_WEB_HOST=0.0.0.0:8080
      - PUFFER_PANEL_REGISTRATIONENABLED=true
      - PUFFER_PANEL_SETTINGS_COMPANYNAME=SkyPanel
      - PUFFER_PANEL_SETTINGS_DEFAULTTHEME=SkyPanel
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Límites de recursos (opcional)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Redes
    networks:
      - skypanel-network

# Volúmenes nombrados
volumes:
  skypanel-config:
    driver: local
  skypanel-data:
    driver: local
  skypanel-logs:
    driver: local

# Redes
networks:
  skypanel-network:
    driver: bridge
